version: '3.8'

services:
  # MySQL Database Service
  mysql:
    image: mysql:8.0
    container_name: disaster-mysql
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_NAME:-disaster_management_v2}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-rootpassword}
    ports:
      - "${DB_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - disaster-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Redis Cache Service
  redis:
    image: redis:7-alpine
    container_name: disaster-redis
    restart: always
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - disaster-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Spring Boot Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: disaster-backend
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-disaster_management_v2}
      DB_USER: root
      DB_PASSWORD: ${DB_PASSWORD:-rootpassword}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET:-DisasterManagementSystemV2SecureJWTSecretKeyForHS512AlgorithmWithAtLeast512BitsLength2025}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400000}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-604800000}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:4200}
    ports:
      - "${SERVER_PORT:-8080}:8080"
    networks:
      - disaster-network
    volumes:
      - ./backend/logs:/app/logs

  # Angular Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: disaster-frontend
    restart: always
    depends_on:
      - backend
    ports:
      - "4200:80"
    networks:
      - disaster-network
    environment:
      API_URL: http://backend:8080

  # Prometheus Monitoring (Optional)
  prometheus:
    image: prom/prometheus:latest
    container_name: disaster-prometheus
    restart: always
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - disaster-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    profiles:
      - monitoring

  # Grafana Dashboards (Optional)
  grafana:
    image: grafana/grafana:latest
    container_name: disaster-grafana
    restart: always
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - disaster-network
    profiles:
      - monitoring

networks:
  disaster-network:
    driver: bridge

volumes:
  mysql_data:
  redis_data:
  prometheus_data:
  grafana_data:
